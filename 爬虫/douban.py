# -*- coding: utf-8 -*-ï¼š
import urllib2
import re
import MySQLdb
import datetime
import urlparse
import time
import requests
import threading

sql = "insert into book_comments(book_name,comment,times,user,star) " \
      "  values(%s,%s,%s,%s,%s)"

select_sql = "select *from book_comments where book_name = %s"
headers = {
    'User-Agent': 'Mozilla/4.0 (compatible; MSIE 5.5; Windows NT)',
    "Host": "book.douban.com",
    "Referer": "https://book.douban.com/tag/",
    "Upgrade-Insecure-Requests": "1"
}

session = requests.session()


def download(url, proxies=None):
    print 'Downloading:', url
    try:

        # request = urllib2.Request(url,headers=headers)

        html = session.get(url, headers=headers, proxies=proxies)

    except urllib2.URLError as e:
        print 'Download Error:', e.reason

    return html


def res(str, html):
    pattern = re.compile(str, re.S)
    text = re.findall(pattern, html)
    return text


coon = MySQLdb.connect(
    host='localhost',
    port=3306,
    user='root',
    passwd='123456',
    db='book',
    charset='utf8'
)

count = 0
cur = coon.cursor()

book_name = ['\xe5\xb0\x8f\xe8\xaf\xb4', '\xe5\xa4\x96\xe5\x9b\xbd\xe6\x96\x87\xe5\xad\xa6', '\xe6\x96\x87\xe5\xad\xa6',
             '\xe9\x9a\x8f\xe7\xac\x94', '\xe4\xb8\xad\xe5\x9b\xbd\xe6\x96\x87\xe5\xad\xa6', '\xe7\xbb\x8f\xe5\x85\xb8',
             '\xe6\x97\xa5\xe6\x9c\xac\xe6\x96\x87\xe5\xad\xa6', '\xe6\x95\xa3\xe6\x96\x87',
             '\xe6\x9d\x91\xe4\xb8\x8a\xe6\x98\xa5\xe6\xa0\x91', '\xe8\xaf\x97\xe6\xad\x8c', '\xe7\xab\xa5\xe8\xaf\x9d',
             '\xe6\x9d\x82\xe6\x96\x87', '\xe7\x8e\x8b\xe5\xb0\x8f\xe6\xb3\xa2',
             '\xe5\x8f\xa4\xe5\x85\xb8\xe6\x96\x87\xe5\xad\xa6', '\xe5\x84\xbf\xe7\xab\xa5\xe6\x96\x87\xe5\xad\xa6',
             '\xe5\x90\x8d\xe8\x91\x97', '\xe5\xbc\xa0\xe7\x88\xb1\xe7\x8e\xb2', '\xe4\xbd\x99\xe5\x8d\x8e',
             '\xe5\xbd\x93\xe4\xbb\xa3\xe6\x96\x87\xe5\xad\xa6', '\xe9\x92\xb1\xe9\x92\x9f\xe4\xb9\xa6',
             '\xe5\xa4\x96\xe5\x9b\xbd\xe5\x90\x8d\xe8\x91\x97', '\xe9\xb2\x81\xe8\xbf\x85', '\xe8\xaf\x97\xe8\xaf\x8d',
             '\xe8\x8c\xa8\xe5\xa8\x81\xe6\xa0\xbc',
             '\xe7\xb1\xb3\xe5\x85\xb0\xc2\xb7\xe6\x98\x86\xe5\xbe\xb7\xe6\x8b\x89',
             '\xe6\x9d\x9c\xe6\x8b\x89\xe6\x96\xaf', '\xe6\xb8\xaf\xe5\x8f\xb0', '\xe6\xbc\xab\xe7\x94\xbb',
             '\xe7\xbb\x98\xe6\x9c\xac', '\xe6\x8e\xa8\xe7\x90\x86', '\xe9\x9d\x92\xe6\x98\xa5',
             '\xe8\xa8\x80\xe6\x83\x85', '\xe7\xa7\x91\xe5\xb9\xbb', '\xe4\xb8\x9c\xe9\x87\x8e\xe5\x9c\xad\xe5\x90\xbe',
             '\xe6\x82\xac\xe7\x96\x91', '\xe6\xad\xa6\xe4\xbe\xa0', '\xe5\xa5\x87\xe5\xb9\xbb',
             '\xe9\x9f\xa9\xe5\xaf\x92', '\xe6\x97\xa5\xe6\x9c\xac\xe6\xbc\xab\xe7\x94\xbb', '\xe8\x80\xbd\xe7\xbe\x8e',
             '\xe4\xba\xa6\xe8\x88\x92', '\xe6\x8e\xa8\xe7\x90\x86\xe5\xb0\x8f\xe8\xaf\xb4', '\xe4\xb8\x89\xe6\xaf\x9b',
             '\xe7\xbd\x91\xe7\xbb\x9c\xe5\xb0\x8f\xe8\xaf\xb4', '\xe5\xae\x89\xe5\xa6\xae\xe5\xae\x9d\xe8\xb4\x9d',
             '\xe9\x83\xad\xe6\x95\xac\xe6\x98\x8e', '\xe7\xa9\xbf\xe8\xb6\x8a', '\xe9\x87\x91\xe5\xba\xb8',
             '\xe8\xbd\xbb\xe5\xb0\x8f\xe8\xaf\xb4',
             '\xe9\x98\xbf\xe5\x8a\xa0\xe8\x8e\x8e\xc2\xb7\xe5\x85\x8b\xe9\x87\x8c\xe6\x96\xaf\xe8\x92\x82',
             '\xe5\x87\xa0\xe7\xb1\xb3', '\xe9\xad\x94\xe5\xb9\xbb', '\xe7\xa7\x91\xe5\xb9\xbb\xe5\xb0\x8f\xe8\xaf\xb4',
             '\xe9\x9d\x92\xe6\x98\xa5\xe6\x96\x87\xe5\xad\xa6', '\xe5\xbc\xa0\xe5\xb0\x8f\xe5\xa8\xb4',
             '\xe5\xb9\xbe\xe7\xb1\xb3', 'J.K.\xe7\xbd\x97\xe7\x90\xb3',
             '\xe9\xab\x98\xe6\x9c\xa8\xe7\x9b\xb4\xe5\xad\x90', '\xe5\x8f\xa4\xe9\xbe\x99', '\xe6\xb2\xa7\xe6\x9c\x88',
             '\xe8\x90\xbd\xe8\x90\xbd', '\xe5\xbc\xa0\xe6\x82\xa6\xe7\x84\xb6', '\xe6\xa0\xa1\xe5\x9b\xad',
             '\xe5\x8e\x86\xe5\x8f\xb2', '\xe5\xbf\x83\xe7\x90\x86\xe5\xad\xa6', '\xe5\x93\xb2\xe5\xad\xa6',
             '\xe4\xbc\xa0\xe8\xae\xb0', '\xe6\x96\x87\xe5\x8c\x96', '\xe7\xa4\xbe\xe4\xbc\x9a\xe5\xad\xa6',
             '\xe8\x89\xba\xe6\x9c\xaf', '\xe8\xae\xbe\xe8\xae\xa1', '\xe7\xa4\xbe\xe4\xbc\x9a',
             '\xe6\x94\xbf\xe6\xb2\xbb', '\xe5\xbb\xba\xe7\xad\x91', '\xe5\xae\x97\xe6\x95\x99',
             '\xe7\x94\xb5\xe5\xbd\xb1', '\xe6\x95\xb0\xe5\xad\xa6', '\xe6\x94\xbf\xe6\xb2\xbb\xe5\xad\xa6',
             '\xe5\x9b\x9e\xe5\xbf\x86\xe5\xbd\x95', '\xe4\xb8\xad\xe5\x9b\xbd\xe5\x8e\x86\xe5\x8f\xb2',
             '\xe6\x80\x9d\xe6\x83\xb3', '\xe5\x9b\xbd\xe5\xad\xa6', '\xe9\x9f\xb3\xe4\xb9\x90',
             '\xe4\xba\xba\xe6\x96\x87', '\xe4\xba\xba\xe7\x89\xa9\xe4\xbc\xa0\xe8\xae\xb0', '\xe7\xbb\x98\xe7\x94\xbb',
             '\xe6\x88\x8f\xe5\x89\xa7', '\xe8\x89\xba\xe6\x9c\xaf\xe5\x8f\xb2', '\xe4\xbd\x9b\xe6\x95\x99',
             '\xe5\x86\x9b\xe4\xba\x8b', '\xe8\xa5\xbf\xe6\x96\xb9\xe5\x93\xb2\xe5\xad\xa6', '\xe4\xba\x8c\xe6\x88\x98',
             '\xe8\xbf\x91\xe4\xbb\xa3\xe5\x8f\xb2', '\xe8\x80\x83\xe5\x8f\xa4',
             '\xe8\x87\xaa\xe7\x94\xb1\xe4\xb8\xbb\xe4\xb9\x89', '\xe7\xbe\x8e\xe6\x9c\xaf', '\xe7\x88\xb1\xe6\x83\x85',
             '\xe6\x97\x85\xe8\xa1\x8c', '\xe7\x94\x9f\xe6\xb4\xbb', '\xe6\x88\x90\xe9\x95\xbf',
             '\xe5\x8a\xb1\xe5\xbf\x97', '\xe5\xbf\x83\xe7\x90\x86', '\xe6\x91\x84\xe5\xbd\xb1',
             '\xe5\xa5\xb3\xe6\x80\xa7', '\xe8\x81\x8c\xe5\x9c\xba', '\xe7\xbe\x8e\xe9\xa3\x9f',
             '\xe6\x95\x99\xe8\x82\xb2', '\xe6\xb8\xb8\xe8\xae\xb0', '\xe7\x81\xb5\xe4\xbf\xae',
             '\xe5\x81\xa5\xe5\xba\xb7', '\xe6\x83\x85\xe6\x84\x9f', '\xe6\x89\x8b\xe5\xb7\xa5',
             '\xe4\xb8\xa4\xe6\x80\xa7', '\xe5\x85\xbb\xe7\x94\x9f', '\xe4\xba\xba\xe9\x99\x85\xe5\x85\xb3\xe7\xb3\xbb',
             '\xe5\xae\xb6\xe5\xb1\x85', '\xe8\x87\xaa\xe5\x8a\xa9\xe6\xb8\xb8', '\xe7\xbb\x8f\xe6\xb5\x8e\xe5\xad\xa6',
             '\xe7\xae\xa1\xe7\x90\x86', '\xe7\xbb\x8f\xe6\xb5\x8e', '\xe5\x95\x86\xe4\xb8\x9a',
             '\xe9\x87\x91\xe8\x9e\x8d', '\xe6\x8a\x95\xe8\xb5\x84', '\xe8\x90\xa5\xe9\x94\x80',
             '\xe5\x88\x9b\xe4\xb8\x9a', '\xe7\x90\x86\xe8\xb4\xa2', '\xe5\xb9\xbf\xe5\x91\x8a',
             '\xe8\x82\xa1\xe7\xa5\xa8', '\xe4\xbc\x81\xe4\xb8\x9a\xe5\x8f\xb2', '\xe7\xad\x96\xe5\x88\x92',
             '\xe7\xa7\x91\xe6\x99\xae', '\xe4\xba\x92\xe8\x81\x94\xe7\xbd\x91', '\xe7\xbc\x96\xe7\xa8\x8b',
             '\xe7\xa7\x91\xe5\xad\xa6', '\xe4\xba\xa4\xe4\xba\x92\xe8\xae\xbe\xe8\xae\xa1',
             '\xe7\x94\xa8\xe6\x88\xb7\xe4\xbd\x93\xe9\xaa\x8c', '\xe7\xae\x97\xe6\xb3\x95', 'web',
             '\xe7\xa7\x91\xe6\x8a\x80', 'UE', '\xe9\x80\x9a\xe4\xbf\xa1', '\xe4\xba\xa4\xe4\xba\x92', 'UCD',
             '\xe7\xa5\x9e\xe7\xbb\x8f\xe7\xbd\x91\xe7\xbb\x9c', '\xe7\xa8\x8b\xe5\xba\x8f']


def download_page(k, page=""):
    while True:
        threading._sleep(5)
        html = download(text[k] + "comments/" + str(page)).text
        page_btn = res('<a class="page-btn" href="(.*?)">.*?</a>', html)
        lens = len(page_btn)
        if lens == 0:
            return
        if lens == 2:
            return

        try:
            bookname = res('<h1>(.*?)</h1>', html)
            star = res(' <span id=".*?" class="vote-count">(.*?)</span>', html)
            name = res('<a[^>]+title=["\'](.*?)["\'].*?</a>', html)
            time = res('<span class=".*?">.*?<span>(.*?)</span>.*?</span>', html)
            comment = res('<p class="comment-content">(.*?)</p>', html)
            print "................................................................"
            for i in range(len(name)):
                print bookname[0], star[i], name[i], time[i]

                try:
                    cur.execute(sql, (
                        bookname[0][:-3],
                        comment[i].strip().replace(" ", "").replace("\n", ""),
                        time[i],
                        name[i],
                        star[i]
                    ))

                    coon.commit()

                except:
                    pass

            print "................................................................"

        except:
            pass

        page = page_btn[lens - 1]


list = ['']
for j in range(len(book_name)):
    for i in range(20):
        if j == 0 and i == 0:
            continue;
        url = 'https://book.douban.com/tag/' + book_name[j] + '?start=' + str(i * 10) + '&type=T'
        threading._sleep(5)
        html = download(url)
        html = html.text
        text = res('<div class="pic".*?<h2.*?>.*?<a href="(.*?)".*?>.*?</a>.*?</h2>.*?</div>', html)
        for k in range(len(text)):
            download_page(k)

"""
CREATE TABLE `book_comments` (
  `_id` int(11) NOT NULL AUTO_INCREMENT,
  `book_name` varchar(100) DEFAULT NULL,
  `comment` varchar(360) DEFAULT NULL,
  `times	` varchar(20) DEFAULT NULL,
  `user` varchar(20) DEFAULT NULL,
  `star` varchar(20) DEFAULT NULL
  PRIMARY KEY (`_id`)
) 
"""
